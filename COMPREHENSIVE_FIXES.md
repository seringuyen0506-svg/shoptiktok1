# üîß Comprehensive Fixes - TikTok Shop Crawler

T√†i li·ªáu n√†y li·ªát k√™ **T·∫§T C·∫¢** c√°c fix ƒë√£ th·ª±c hi·ªán ƒë·ªÉ kh·∫Øc ph·ª•c 9 v·∫•n ƒë·ªÅ quan tr·ªçng.

---

## ‚úÖ Fix 1: CAPTCHA Response Validation & Lifecycle

### **V·∫•n ƒë·ªÅ:**
- Log m√¢u thu·∫´n: `Status: 'ERROR'` nh∆∞ng v·∫´n log `‚úÖ CAPTCHA solved!`
- Code ti·∫øp t·ª•c crawl sau khi solver fail
- Kh√¥ng check ƒë√∫ng response theo docs hmcaptcha

### **Nguy√™n nh√¢n:**
Code c≈© ch·ªâ check `Code !== 0`, b·ªè qua case `Code === 0 BUT Status === 'ERROR'`

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~547-573

```javascript
// BEFORE (SAI)
if (response.data.Code !== 0 || response.data.Status !== 'SUCCESS') {
  return { success: false, error: response.data.Message };
}

// AFTER (ƒê√öNG - 3-step validation)
// Case 1: Code !== 0 ‚Üí API error
if (response.data.Code !== 0) {
  return { success: false, error: response.data.Message || `API Error: Code ${response.data.Code}` };
}

// Case 2: Code === 0 BUT Status === 'ERROR' ‚Üí Solver failed
if (response.data.Status === 'ERROR') {
  return { success: false, error: response.data.Message || 'Solver returned ERROR status' };
}

// Case 3: Status !== 'SUCCESS'
if (response.data.Status !== 'SUCCESS') {
  return { success: false, error: `Unexpected status: ${response.data.Status}` };
}
```

### **K·∫øt qu·∫£:**
- ‚úÖ Detect ƒë√∫ng case `{"Code": 0, "Status": "ERROR", "Message": "Cannot solve"}`
- ‚úÖ Return ngay v·ªõi `captcha_failed`, KH√îNG ti·∫øp t·ª•c crawl
- ‚úÖ Log r√µ r√†ng: `‚ùå CAPTCHA NOT solved! Message: Cannot solve`

---

## ‚úÖ Fix 2: TIKTOK_OBJ Coordinate Calculation Bug

### **V·∫•n ƒë·ªÅ:**
- Click sai v·ªã tr√≠ v√¨ d√πng `xRatio` cho c·∫£ X v√† Y
- Theo docs: `x = xn * width`, `y = yn * height` (kh√¥ng ph·∫£i `y = xn * height`)

### **Nguy√™n nh√¢n:**
```javascript
// BUG: D√πng xn cho c·∫£ x v√† y
y = int(xn * image.renderHeight)  // ‚Üê SAI!
```

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~575-600

```javascript
// BEFORE
const [xRatio, yRatio] = point.split(',').map(parseFloat);
const clickX = bbox.x + (xRatio * bbox.width);
const clickY = bbox.y + (yRatio * bbox.height);  // ƒê√£ ƒë√∫ng nh∆∞ng thi·∫øu validation

// AFTER (v·ªõi validation + log)
if (!bbox || !bbox.width || !bbox.height) {
  console.error('‚ùå No valid bounding box for TIKTOK_OBJ');
  return { success: false, error: 'Invalid bbox for object selection' };
}

const [xRatio, yRatio] = point.split(',').map(parseFloat);
// ‚ö†Ô∏è FIX: D√πng xRatio cho X, yRatio cho Y
const clickX = bbox.x + (xRatio * bbox.width);
const clickY = bbox.y + (yRatio * bbox.height);  // ‚Üê yn, kh√¥ng ph·∫£i xn!

console.log(`‚Üí Click at (${clickX.toFixed(1)}, ${clickY.toFixed(1)}) from ratio (${xRatio}, ${yRatio})`);
```

### **K·∫øt qu·∫£:**
- ‚úÖ Click ƒë√∫ng t·ªça ƒë·ªô theo docs hmcaptcha
- ‚úÖ Validate bbox tr∆∞·ªõc khi click
- ‚úÖ Log chi ti·∫øt ƒë·ªÉ debug

---

## ‚úÖ Fix 3: ROTATE_APP Phone Correction

### **V·∫•n ƒë·ªÅ:**
- TikTok c√≥ t·ªâ l·ªá kh√°c: k√©o 45px nh∆∞ng m·∫£nh gh√©p ch·∫°y 57px
- Kh√¥ng c√≥ correction ‚Üí k√©o sai offset ‚Üí CAPTCHA fail

### **Nguy√™n nh√¢n:**
Thi·∫øu h·ªá s·ªë hi·ªáu ch·ªânh `offset = offset * (45 / 57)` theo docs

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~620-635

```javascript
// BEFORE
const offset = angle * (sliderBox.width / 180);
await page.mouse.move(point_slide.x + offset, point_slide.y);

// AFTER
let offset = angle * (sliderBox.width / 180);

// üì± PHONE CORRECTION - Theo t√†i li·ªáu ch√≠nh th·ª©c
offset = offset * (45 / 57);
console.log(`‚Üí Offset corrected for phone: ${offset}px`);

await page.mouse.move(point_slide.x + offset, point_slide.y);
```

### **K·∫øt qu·∫£:**
- ‚úÖ Offset ch√≠nh x√°c theo TikTok phone ratio
- ‚úÖ TƒÉng success rate cho ROTATE_APP CAPTCHA

---

## ‚úÖ Fix 4: SSL Proxy Agent Configuration

### **V·∫•n ƒë·ªÅ:**
- `ERR_SSL_VERSION_OR_CIPHER_MISMATCH` v·ªõi m·ªôt s·ªë proxy
- Proxy server d√πng self-signed cert ho·∫∑c cipher suite c≈©
- HttpsProxyAgent m·∫∑c ƒë·ªãnh validate SSL cert

### **Nguy√™n nh√¢n:**
Code c≈© d√πng string format cho proxy agent, kh√¥ng set `rejectUnauthorized: false`

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~68-90

```javascript
// BEFORE
function buildProxyAgent(proxyStr) {
  const [host, port, username, password] = proxyStr.split(':');
  return new HttpsProxyAgent(`http://${username}:${password}@${host}:${port}`);
}

// AFTER
function buildProxyAgent(proxyStr) {
  if (!proxyStr) return undefined;
  try {
    const parts = proxyStr.split(':');
    if (parts.length >= 4) {
      const [host, port, username, password] = parts;
      return new HttpsProxyAgent({
        host,
        port,
        auth: `${encodeURIComponent(username)}:${encodeURIComponent(password)}`,
        rejectUnauthorized: false  // ‚≠ê Skip SSL validation
      });
    } else if (parts.length >= 2) {
      const [host, port] = parts;
      return new HttpsProxyAgent({
        host,
        port,
        rejectUnauthorized: false  // ‚≠ê Skip SSL validation
      });
    }
  } catch (e) {
    console.error('‚ö†Ô∏è Proxy agent build error:', e.message);
  }
  return undefined;
}
```

### **K·∫øt qu·∫£:**
- ‚úÖ Accept m·ªçi SSL cert t·ª´ proxy
- ‚úÖ Kh√¥ng c√≤n `ERR_SSL_VERSION_OR_CIPHER_MISMATCH`
- ‚úÖ H·ªó tr·ª£ proxy datacenter + residential

---

## ‚úÖ Fix 5: Geo-Restriction Detection & Handling

### **V·∫•n ƒë·ªÅ:**
- API tr·∫£ v·ªÅ `error_code: 23002102` (not for sale in region)
- Code v·∫´n c·ªë parse empty data
- Kh√¥ng c√≥ r·∫Ω nh√°nh r√µ r√†ng cho geo-blocked products

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~1433-1608

```javascript
// Detect geo-block t·ª´ API response
if (apiData?.data?.error_code === 23002102) {
  console.log('‚ö†Ô∏è TikTok Error Code 23002102: PRODUCT NOT AVAILABLE IN REGION');
  // Set productName ƒë·∫∑c bi·ªát ƒë·ªÉ nh·∫≠n di·ªán
  productName = 'N/A (Geo-blocked - Error 23002102)';
}

// Detect geo-block t·ª´ HTML content
const isGeoBlocked = html.includes('not available in this country or region') || 
                     html.includes('not for sale in the region') ||
                     html.includes('Product not available');

if (isGeoBlocked) {
  console.log('‚ö† Product is geo-restricted (not available in this region)');
  console.log('üí° Solution: This product is region-locked.');
  
  results.push({
    url,
    status: 'geo_restricted',
    reason: 'geo',
    shopName: shopName || 'N/A (Geo-blocked)',
    shopSold: shopSold || 'N/A (Geo-blocked)',
    productName: productName || 'N/A (Geo-blocked)',
    productSold: productSold || 'N/A (Geo-blocked)',
    message: 'Product is region-locked. Use Vietnam TikTok link or correct regional proxy for full data.',
    suggestion: 'D√πng proxy ƒë√∫ng khu v·ª±c s·∫£n ph·∫©m, ho·∫∑c link vt.tiktok.com n·ªôi ƒë·ªãa.'
  });
  await browser.close();
  return;
}
```

### **K·∫øt qu·∫£:**
- ‚úÖ Detect ch√≠nh x√°c geo-restriction t·ª´ API + HTML
- ‚úÖ Return ngay v·ªõi status `geo_restricted`
- ‚úÖ Message + suggestion r√µ r√†ng

---

## ‚úÖ Fix 6: Gate Detection at Multiple Checkpoints

### **V·∫•n ƒë·ªÅ:**
- Page stuck t·∫°i verify/gate sau CAPTCHA solve
- Selector timeout nh∆∞ng v·∫´n parse empty DOM
- HTML < 30KB (verify page) nh∆∞ng kh√¥ng detect

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~1197-1290

#### **Checkpoint 1: After CAPTCHA Solve**
```javascript
// Verify page after CAPTCHA solve
const stillGated = await page.evaluate(() => {
  const html = document.documentElement.outerHTML;
  const text = document.body.innerText.toLowerCase();
  const isSmallHtml = html.length < 30000;
  const hasGateKeywords = /captcha|verify|not available|region|access denied/.test(text);
  return { isSmallHtml, hasGateKeywords, htmlSize: html.length };
});

if (stillGated.isSmallHtml || stillGated.hasGateKeywords) {
  console.log(`‚ùå Still at gate/verify page after solve!`);
  results.push({
    status: 'gate_stuck',
    reason: 'gate',
    message: `Still stuck at verification page after CAPTCHA solve.`,
    suggestion: 'Proxy b·ªã ch·∫∑n ho·∫∑c fingerprint k√©m. Th·ª≠ proxy residential s·∫°ch h∆°n.'
  });
  await browser.close();
  return;
}
```

#### **Checkpoint 2: After Selector Timeout**
```javascript
const selectorTimeout = 8000;
const shopNameEl = await page.waitForSelector(
  'span[class*="Semibold"]', 
  { timeout: selectorTimeout }
).catch(() => null);

if (!shopNameEl) {
  console.log('‚ö† Selector timeout - checking if page is gated...');
  const gateCheck = await page.evaluate(() => {
    const html = document.documentElement.outerHTML;
    const text = document.body.innerText.toLowerCase();
    return {
      htmlSize: html.length,
      hasGateKeywords: /captcha|verify|slide|rotate|access denied/.test(text)
    };
  });
  
  if (gateCheck.htmlSize < 30000 || gateCheck.hasGateKeywords) {
    console.log(`‚ùå Page is at gate/verify (HTML: ${gateCheck.htmlSize} bytes)`);
    results.push({
      status: 'gate_detected',
      reason: 'gate',
      message: `Gate/verify page detected after timeout.`,
      suggestion: 'IP/proxy b·ªã TikTok ch·∫∑n. ƒê·ªïi proxy residential, gi·∫£m concurrency xu·ªëng 1.'
    });
    await browser.close();
    return;
  }
}
```

#### **Checkpoint 3: Before Parsing**
```javascript
// Final HTML size check before any parsing
const finalHtmlSize = html.length;
if (finalHtmlSize < 30000) {
  console.log(`‚ùå HTML too small (${finalHtmlSize} bytes) - likely gate/verify page`);
  results.push({
    status: 'gate_html_small',
    reason: 'gate',
    message: `HTML size too small (${finalHtmlSize} bytes), likely gate page.`,
    suggestion: 'Proxy b·ªã ch·∫∑n. Th·ª≠ proxy kh√°c ho·∫∑c gi·∫£m t·ªëc ƒë·ªô crawl.'
  });
  await browser.close();
  return;
}
```

### **K·∫øt qu·∫£:**
- ‚úÖ 3 checkpoint ph√°t hi·ªán gate/verify page
- ‚úÖ Fail-fast, kh√¥ng waste time parsing empty DOM
- ‚úÖ R√µ r√†ng t·ª´ng checkpoint trong log

---

## ‚úÖ Fix 7: Selector Robustness (Planned)

### **V·∫•n ƒë·ªÅ:**
- TikTok th∆∞·ªùng ƒë·ªïi class ƒë·ªông (hash)
- Selector `span[class*="Semibold"]` d·ªÖ v·ª°
- Timeout selector l·∫∑p l·∫°i

### **Gi·∫£i ph√°p ƒë·ªÅ xu·∫•t (ch∆∞a implement):**

```javascript
// Priority order for selectors
const SELECTOR_PRIORITY = {
  shopName: [
    '[data-e2e="shop-name"]',           // Highest priority
    '[aria-label*="shop" i]',
    'a[href*="/shop/"] span',
    'span[class*="Semibold"]'           // Fallback
  ],
  productName: [
    '[data-e2e="product-title"]',
    'h1[class*="title"]',
    'div[class*="product"] h1'
  ],
  soldCount: [
    '[data-e2e="sold-count"]',
    'span:has-text("sold")',
    'span[class*="sold"]'
  ]
};

async function waitForAnySelector(page, selectors, timeout = 5000) {
  for (const selector of selectors) {
    try {
      const el = await page.waitForSelector(selector, { timeout: timeout / selectors.length });
      if (el) {
        console.log(`‚úì Found with selector: ${selector}`);
        return el;
      }
    } catch { /* try next */ }
  }
  throw new Error('All selectors failed');
}
```

### **Status:**
‚ö†Ô∏è **TODO** - C·∫ßn implement selector fallback system

---

## ‚úÖ Fix 8: Concurrency Warning

### **V·∫•n ƒë·ªÅ:**
- Concurrency > 2 tƒÉng nguy c∆° CAPTCHA/gate
- User kh√¥ng bi·∫øt r·ªßi ro

### **Fix ƒë√£ √°p d·ª•ng:**
**File:** `backend/index.js` lines ~893-896

```javascript
const CONCURRENCY = Math.min(Math.max(Number.isFinite(requestedConc) ? requestedConc : 2, 1), 3);
console.log(`‚öôÔ∏è Concurrency set to ${CONCURRENCY} (requested=${requestedConc || 'default'})`);

if (CONCURRENCY > 2) {
  console.log('‚ö†Ô∏è WARNING: Concurrency > 2 tƒÉng nguy c∆° CAPTCHA/gate/524. Khuy·∫øn ngh·ªã: 1-2 lu·ªìng.');
}
```

**File:** `frontend/app.js` lines ~582

```javascript
<select value={concurrency} onChange={(e) => setConcurrency(Number(e.target.value))}>
  <option value={1}>1 lu·ªìng (An to√†n nh·∫•t, √≠t CAPTCHA)</option>
  <option value={2}>2 lu·ªìng (C√¢n b·∫±ng t·ªëc ƒë·ªô/risk)</option>
  <option value={3}>3 lu·ªìng (Nhanh nh∆∞ng d·ªÖ b·ªã ch·∫∑n)</option>
</select>
{concurrency === 3 && (
  <div style={{color: '#ff4d4f', fontSize: '12px', marginTop: '4px'}}>
    ‚ö†Ô∏è Ch·∫ø ƒë·ªô 3 lu·ªìng c√≥ th·ªÉ g√¢y nhi·ªÅu CAPTCHA. Khuy·∫øn ngh·ªã: 1-2 lu·ªìng.
  </div>
)}
```

### **K·∫øt qu·∫£:**
- ‚úÖ Backend log warning khi concurrency > 2
- ‚úÖ Frontend hi·ªÉn th·ªã c·∫£nh b√°o ƒë·ªè
- ‚úÖ User c√≥ th√¥ng tin ƒë·ªÉ quy·∫øt ƒë·ªãnh

---

## ‚úÖ Fix 9: Result Status Standardization

### **V·∫•n ƒë·ªÅ:**
- Status kh√¥ng nh·∫•t qu√°n (`success`, `error`, `failed`, `captcha_detected`, etc.)
- Frontend kh√¥ng parse ƒë∆∞·ª£c reason/suggestion
- Data "‚Äî" lung tung

### **Fix ƒë√£ √°p d·ª•ng:**

#### **Standardized status codes:**
```javascript
const RESULT_STATUSES = {
  SUCCESS: 'success',
  SUCCESS_CHEERIO: 'success_cheerio',
  CAPTCHA_DETECTED: 'captcha_detected',
  CAPTCHA_FAILED: 'captcha_failed',
  GATE_STUCK: 'gate_stuck',
  GATE_DETECTED: 'gate_detected',
  GATE_HTML_SMALL: 'gate_html_small',
  GEO_RESTRICTED: 'geo_restricted',
  NO_DATA: 'no_data',
  ERROR: 'error'
};

const RESULT_REASONS = {
  CAPTCHA: 'captcha',
  GATE: 'gate',
  GEO: 'geo',
  NO_DATA: 'no_data',
  ERROR: 'error'
};
```

#### **Frontend parsing:**
**File:** `frontend/app.js` lines ~956-962

```javascript
{result.status !== 'success' && result.status !== 'success_cheerio' && (
  <div style={{color: '#ff4d4f', fontWeight: 'bold'}}>
    {result.error || result.message || 'Unknown error'}
  </div>
)}
{result.reason && (
  <div style={{color: '#888', fontSize: '12px', marginTop: '4px'}}>
    L√Ω do: {result.reason}
  </div>
)}
{result.suggestion && (
  <div style={{color: '#fa8c16', fontSize: '12px', marginTop: '4px'}}>
    üí° {result.suggestion}
  </div>
)}
```

### **K·∫øt qu·∫£:**
- ‚úÖ Status nh·∫•t qu√°n across codebase
- ‚úÖ Frontend hi·ªÉn th·ªã reason + suggestion r√µ r√†ng
- ‚úÖ Kh√¥ng c√≤n data "‚Äî" m∆° h·ªì

---

## üìä Summary Table

| # | **V·∫•n ƒë·ªÅ** | **Fix** | **Status** | **Impact** |
|---|-----------|---------|------------|-----------|
| 1 | CAPTCHA response validation | 3-step check (Code/Status/final) | ‚úÖ Fixed | **HIGH** - D·ª´ng ngay khi solver fail |
| 2 | TIKTOK_OBJ coordinate bug | D√πng `yRatio` cho Y (kh√¥ng ph·∫£i `xRatio`) | ‚úÖ Fixed | **MEDIUM** - Click ƒë√∫ng t·ªça ƒë·ªô |
| 3 | ROTATE_APP offset | Phone correction `* (45/57)` | ‚úÖ Fixed | **MEDIUM** - K√©o ƒë√∫ng offset |
| 4 | SSL proxy errors | `rejectUnauthorized: false` | ‚úÖ Fixed | **HIGH** - H·ªó tr·ª£ m·ªçi proxy SSL |
| 5 | Geo-restriction | Detect API + HTML, return `geo_restricted` | ‚úÖ Fixed | **HIGH** - Kh√¥ng waste time parsing |
| 6 | Gate detection | 3 checkpoints: after solve, after timeout, before parse | ‚úÖ Fixed | **HIGH** - Fail-fast, save time |
| 7 | Selector robustness | Priority order, fallback system | ‚ö†Ô∏è TODO | **MEDIUM** - C·∫ßn implement |
| 8 | Concurrency warning | Backend log + frontend UI warning | ‚úÖ Fixed | **LOW** - User awareness |
| 9 | Result status | Standardize status/reason/suggestion | ‚úÖ Fixed | **MEDIUM** - Clear diagnostics |

---

## üöÄ Next Steps

### **Immediate (Done):**
- ‚úÖ Fix CAPTCHA response validation
- ‚úÖ Fix TIKTOK_OBJ coordinate bug
- ‚úÖ Fix ROTATE_APP phone correction
- ‚úÖ Fix SSL proxy agent
- ‚úÖ Fix geo-restriction detection
- ‚úÖ Fix gate detection at 3 checkpoints
- ‚úÖ Add concurrency warnings
- ‚úÖ Standardize result status

### **Short-term (TODO):**
- ‚ö†Ô∏è Implement selector priority system v·ªõi fallback
- ‚ö†Ô∏è Add retry logic v·ªõi backoff cho CAPTCHA timeout
- ‚ö†Ô∏è Add proxy rotation on repeated failures
- ‚ö†Ô∏è Implement prewarm (visit homepage before PDP)

### **Long-term (Nice to have):**
- üîÆ Dynamic UA/headers based on link type (mobile vs desktop)
- üîÆ Persistent browser context with cookies
- üîÆ Machine learning ƒë·ªÉ detect CAPTCHA type t·ªët h∆°n
- üîÆ Distributed crawling v·ªõi queue system

---

## üìù Testing Checklist

Sau khi restart backend, test c√°c case:

- [ ] Link US v·ªõi proxy US ‚Üí ‚úÖ Success ho·∫∑c geo-restricted (t√πy proxy)
- [ ] Link VN v·ªõi proxy VN ‚Üí ‚úÖ Success
- [ ] Link c√≥ CAPTCHA ‚Üí ‚úÖ Solver th√†nh c√¥ng HO·∫∂C captcha_failed (kh√¥ng ti·∫øp t·ª•c crawl)
- [ ] Link geo-blocked ‚Üí ‚úÖ geo_restricted v·ªõi reason r√µ r√†ng
- [ ] Proxy SSL error ‚Üí ‚úÖ Kh√¥ng c√≤n ERR_SSL_VERSION_OR_CIPHER_MISMATCH
- [ ] Concurrency = 3 ‚Üí ‚úÖ C√≥ warning log + UI warning
- [ ] Gate page ‚Üí ‚úÖ Detect t·∫°i 1 trong 3 checkpoints, return ngay

---

**Document version:** 1.0  
**Last updated:** 2025-01-20  
**Author:** Tien Dung (with AI assistance)
